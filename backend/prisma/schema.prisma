// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Token {
  id String @id @default(uuid())
  token String @unique
  createdAt DateTime @default(now())
  expires_at DateTime
  
  @@map("token")
}

model User {
  id String @id @default(uuid())
  email String @unique
  is_verified Boolean @default(false)
  role Role @default(user)
  referral_code String @unique
  
  password String?
  first_name String?
  last_name String?
  avatar String?
  avatar_id String?
  referrerId String?

  referrer User? @relation("ReferredBy", fields: [referrerId], references: [id])
  referredUsers User[] @relation("ReferredBy")

  created_at DateTime @default(now())
  updated_at DateTime

  voucher User_Voucher[]
  refreshTokens RefreshToken[]
  address UserAddress[]
  carts   Cart[]
  orders  Order[]

  @@map("users")
}

enum Role {
  user
  admin
  super
}

model Voucher {
  id String @id @default(uuid())
  voucher_name String @unique
  voucher_type Type @default(shopping)
  discount_type String
  discount_value Decimal
  max_discount Decimal
  min_purchase Decimal
  created_at DateTime

  user User_Voucher[]

  @@map("voucher")
}

model User_Voucher {
  id String @id @default(uuid())
  user_id String
  voucher_id String
  is_used Boolean @default(false)
  used_at DateTime
  obtained_at DateTime
  expired_at DateTime

  userId User @relation(fields: [user_id], references: [id])
  voucher Voucher @relation(fields: [voucher_id], references: [id])

  @@map("user_voucher")
}

enum Type {
  shopping
  shipping
}

model RefreshToken {
  id String @id @default(uuid())
  user_id String
  token String @unique
  expires_at DateTime

  user User @relation(fields: [user_id], references: [id])
}

model UserAddress {
  id String @id @default(uuid())
  user_id String
  first_name String
  last_name String
  address String
  province Int
  city Int
  postal_code Int
  latitude Int
  longitude Int
  is_main_address Boolean
  created_at DateTime @default(now())
  updated_at DateTime

  userId User @relation(fields: [user_id], references: [id])
  provinceId Province @relation(fields: [province], references: [id])
  userCity City @relation(fields: [city], references: [id])

  orders  Order[]

  @@map("user_address")
}

model Province {
  id Int @id
  province_name String

  userAddress UserAddress[]
  cities City[]

  @@map("province")
}

model City {
  id Int @id
  provinceId Int
  city_name String
  type String

  province Province @relation(fields: [provinceId], references: [id])
  address UserAddress[]

  @@map("city")
}

model Cart {
  id        String  @id @default(uuid())

  quantity  Int     @default(1)

  userId    String  @map("user_id")
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("carts")
}

enum OrderStatus {
  WAITING_PAYMENT
  WAITING_CONFIRMATION
  CONFIRMED
  CANCELLED
  PRESCRIBED
  SHIPPED
  DELIVERED
}

model Order {
  id                  String      @id @default(uuid())
  orderNumber         String      @unique @map("order_number")

  subtotal            Decimal     @db.Decimal(10, 2)
  discountAmount      Decimal     @default(0) @map("discount_amount") @db.Decimal(10, 2)
  shippingCost        Decimal     @map("shipping_cost") @db.Decimal(10, 2)
  shippingDiscount    Decimal     @default(0) @map("shipping_discount") @db.Decimal(10, 2)
  totalAmount         Decimal     @map("total_amount") @db.Decimal(10, 2)

  estimatedDelivery   String?     @map("estimated_delivery")

  voucherCodeUsed     String?     @map("voucher_code_used")

  status              OrderStatus
  paymentProof        String?     @map("payment_proof")

  paymentConfirmedAt  DateTime?   @map("payment_confirmed_at")
  shippedAt           DateTime?   @map("shipped_at")
  confirmedAt         DateTime?   @map("confirmed_at")
  cancelledAt         DateTime?   @map("cancelled_at")
  cancellationReason  String?     @map("cancellation_reason")

  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")
  
  userId              String      @map("user_id")
  user                User        @relation(fields: [userId], references: [id], onDelete: Restrict)
  userAddressId       String      @map("user_address_id")
  userAddress         UserAddress @relation(fields: [userAddressId], references: [id], onDelete: Restrict)

  orderItems          OrderItem[]

  @@map("orders")
}

model OrderItem {
  id              String    @id @default(uuid())

  orderId         String    @map("order_id")
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  quantity        Int
  price           Decimal   @db.Decimal(10, 2)
  discountAmount  Decimal   @default(0) @map("discount_amount") @db.Decimal(10, 2)
  subtotal        Decimal   @db.Decimal(10, 2)

  createdAt       DateTime  @default(now()) @map("created_at")

  @@map("order_items")
}